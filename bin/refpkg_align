#!/bin/bash +x

# align sequences, merge with reference alignment, and convert to a
# .gz compressed fasta file.

set -e

refpkg=$1
fasta=$2

merged=$3
scores=$4

cpu=${5-8}

ref_sto=$(taxit rp $refpkg aln_sto)
profile=$(taxit rp $refpkg profile)

sto=$(mktemp -u).sto

cmalign --cpu $cpu -o "$sto" --sfile "${scores%.gz}" --noprob --dnaout "$profile" "$fasta" | grep -E '^#'

esl-alimerge --dna --outformat afa "$ref_sto" "$sto" | \
    seqmagick convert --apply-function bin/seqmagick_extensions.py:replace_dots - "${merged:?}"

gzip -f "${scores%.gz}"

rm $sto $merged_sto
