---
title: Plate 12 Barcodecop comparison
author: Noah Hoffman
date: "`r format(Sys.time(), '%Y-%m-%d')`"
output:
  html_document:
    toc: true
---

# Introduction

In this experiment, we compare four processing conditions for the same MiSeq plate (plate 12):

- fastqs as they are produced by the onboard MiSeq demiultiplexing software (**nofilter**)
- processing with barcodecop, enforcing exact barcode matches (**match**)
- processing with barcodecop, discarding reads when either barcode (reads are dual-indexed) has average quality score < 26 (**qual**)
- processing with barcodecop, with both exact barcode matches and quality filtering (**match+qual**)

After quality filtering, reads were processed with dada2 and classified as usual.

```{sh}
pwd
```

A representative settings file:

```{sh}
cat settings-match-qual.conf
```

# setup

Set up environment

```{r}
library(knitr)
library(tidyr)
```

Read classification results.

```{r results='asis'}
tabs <- c(
    './output-nofilter/by_specimen.species.csv',
    './output-match-filter/by_specimen.species.csv',
    './output-qual-filter/by_specimen.species.csv',
    './output-match-qual/by_specimen.species.csv'
)
labels <- c('nofilter', 'match', 'qual', 'match+qual')
tab <- do.call(rbind, lapply(seq_along(labels), function(i){
  x <- read.csv(tabs[i])
  x$label <- labels[i]
  x
}))
tab$label <- factor(tab$label, levels=labels)
knitr::kable(head(tab))
```

Read specimen annotation

```{r}
annotation <- read.csv('output/labels.csv')
specimen_id <- sapply(strsplit(as.character(annotation$sample_name), split='-'), '[', 2)
specimen_id <- gsub('_conc', '', sapply(strsplit(as.character(specimen_id), split=' '), '[', 1))
annotation$specimen_id <- ifelse(grepl('\\d{5}', specimen_id), specimen_id, NA)
knitr::kable(head(annotation))
```

```{r}
metadata <- read.csv('output/metadata.csv')
metadata$specimen_id <- as.character(metadata$specimen_id)
sampleid <- annotation$sampleid
annotation <- merge(annotation, metadata[,c('specimen_id', 'ct_naat')],
                    by='specimen_id', all.x=TRUE, all.y=FALSE, sort=FALSE)
stopifnot(setequal(sampleid, annotation$sampleid))
```

# yield

What proportion of reads remain after applying each set of parameters?

```{r}
by_specimen <- aggregate(tally ~ specimen + label, tab, sum)
tallies <- spread(by_specimen[,c('specimen', 'label', 'tally')], label, tally)
yields <- as.data.frame(apply(tallies[,c(-1, -2)], 2, function(col) col/tallies$nofilter))
rownames(yields) <- tallies$specimen
```

Summary statistics for yield.

```{r results='asis'}
knitr::kable(apply(yields, 2, summary))
```

Note that there is a specimen with "qual" > 100% yield... the numbers
don't quite add up, probably because singletons are dropped in the
dada2 step, and the different treatments could wind up with more than
unfiltered because singletons are defined according to other reads that
are present.

# Chlamydia trachomatis

It was the appearance of CT among specimens know to be negative for
that organism by a separate assay that led to our investigation of
barcode filtering to begin with.

```{r}
ct <- tab[tab$tax_name == "Chlamydia trachomatis", c('specimen', 'label', 'tally')]
ct_wide <- tidyr::spread(ct, label, tally, fill=0)
ct_wide <- merge(annotation[,c('sampleid', 'sample_name', 'specimen_id',
                               'project', 'ct_naat', 'controls')],
                 ct_wide, by.x='sampleid', by.y='specimen')
```

List counts of CT in all specimens for each set of pre-processing
parameters.

```{r results='asis'}
knitr::kable(ct_wide[order(ct_wide$nofilter, decreasing=TRUE),])
```

Limit to CT NAAT negative specimens. How many specimens have CT counts
reduced to zero for each treatment condition?

```{r}
ct_neg <- ct_wide[ct_wide$ct_naat %in% c('Negative'),]
nrow(ct_neg)
zeros <- as.data.frame(do.call(rbind, lapply(labels[-1], function(col){table(ct_neg[[col]] == 0)})))
rownames(zeros) <- labels[-1]
colnames(zeros) <- c('nonzero', 'zero')
zeros$pct_zero <- round(with(as.data.frame(zeros), 100 * zero/(zero + nonzero)), 1)
zeros
```

Conclusion of this: **58% of specimens of NAAT negative specimens have no detectable CT after filtering**

Counts for all NAAT-negative specimens.

```{r results='asis'}
knitr::kable(ct_neg[order(ct_neg$nofilter, decreasing=TRUE),])
```

# classifications in the mock community

This plate includes a mock community specimen. There should be three categories of organisms in this specimen:

- organisms known to be members of the community
- organisms introduced from reagents (water bugs, etc, but also potentially cross contamination from other specimens during extraction, etc)
- organisms represented by mis-assigned reads

Organisms known to be in the mock community (note that L. crispatus is
being classified as L. helveticus and L. acidophilus/crispatus):

```{r}
in_mock <- strsplit('Lactobacillus acidophilus/crispatus
Lactobacillus gasseri
Lactobacillus jensenii
Lactobacillus helveticus
Prevotella bivia
Prevotella timonensis
Atopobium vaginae
Aerococcus christensenii
Parvimonas micra
Megasphaera sp. type 2
Lactobacillus iners
Gardnerella vaginalis
Prevotella amnii
Mageeibacillus indolicus', split='\n')[[1]]
```

```{r results='asis'}
mock <- tab[tab$specimen == "m12n726s520",c('tax_name', 'label', 'tally')]
mock_wide <- tidyr::spread(mock, label, tally, fill=0)
mock_wide <- mock_wide[order(mock_wide$nofilter, decreasing=TRUE),]
mock_wide$in_mock <- ifelse(mock_wide$tax_name %in% in_mock, 'yes', 'no')
knitr::kable(mock_wide)
```

Note that reductions in read counts are uniformly higher for organisms known not to be in the mock community:

```{r}
with(mock_wide, split(`match+qual`/nofilter, in_mock))
```

# project info

```{sh}
pwd
git remote -v
git --no-pager log -n1
git status
```
