---
title: High-level summary of CRC3 results from miseq plate 12
author: Noah Hoffman
date: "`r format(Sys.time(), '%Y-%m-%d')`"
output:
  html_document:
    toc: true
---

# document history

- **2011-11-21**: first draft

# setup

Set up environment

```{r}
venv <- list.files(pattern='*-env')
stopifnot(length(venv) == 1)
Sys.setenv(VIRTUAL_ENV=normalizePath(venv))
source(file.path(Sys.getenv('VIRTUAL_ENV'), 'bin', 'rvenv'))
```

Load dependencies.

```{r}
library(phyloseq)
library(lattice)
library(latticeExtra)
options(width=100)
```

load data

```{r}
load('./output-crc3/CRC3-phyloseq.rda')
```

# visualization of communities by relative abundance

## dendrogram of specimens

Perform a very naive clustering by specimen (according to euclidean
distances of relative abundances of species) to provide an ordering
for the specimens - this can be replaced by a more appropriate
clustering method later.

```{r}
phy.rel <- transform_sample_counts(phy, function(OTU) OTU/sum(OTU))
specimen.dist <- dist(t(as.matrix(otu_table(phy.rel))))
specimen.clust <- hclust(specimen.dist)
specimen.dend <- as.dendrogram(specimen.clust)
```

## prepare taxonomy

Recalculate tax_table as a square (as opposed to a ragged) matrix so
that there is a name in the species column for each organism, even for
those without a species-level classification.

```{r}
title_case <- function(x){
  paste0(toupper(substr(x, 1, 1)), tolower(substring(x, 2)))
}

ranks <- c("superkingdom", "phylum", "class", "order", "family", "genus", "species")
rank.titles <- title_case(ranks)
root <- setNames('Root', 'Rank1')
taxlist <- lapply(rownames(classif), function(otu){
  row <- c(root, setNames(as.character(classif[otu,-1]), rank.titles))
})
names(taxlist) <- rownames(classif)
phy1 <- phy
tax_table(phy1) <- phyloseq::build_tax_table(taxlist)
```

## aggregate counts by organism name

Combine counts for each species and transform to fractional abundance
(see http://joey711.github.io/phyloseq/preprocess).

```{r}
rank_name <- 'Species'
phy.organism <- phyloseq::tax_glom(phy1, rank_name)
phy.organism.rel <- transform_sample_counts(phy.organism, function(OTU) OTU/sum(OTU))
phy.organism
```

Now that phyloseq has aggregated OTUs by organism, extract the otu
table. Order organisms along rows according to the taxonomy.

```{r}
organism <- tax_table(phy.organism)[, rank_name]
otutab <- otu_table(phy.organism.rel)
rownames(otutab) <- organism[rownames(otutab)]
otutab <- otutab[organism,]
```

As a first pass, limit to organisms present in at least N specimens.

```{r}
min_prevalence <- 15
prevalence <- apply(otutab, 1, function(row) sum(row > 0))
summary(prevalence)
table(prevalence >= min_prevalence)
keep <- prevalence[prevalence >= min_prevalence]
```

Aggregate low-prevalence organisms into an "other" category. Order
specimens according to the dendrogram.

```{r}
other_name <- "(other)"
otutab.keep <- otutab[names(keep),]
otutab.other <- otutab[!rownames(otutab) %in% names(keep),]
plot.data <- rbind(colSums(otutab.other), otutab.keep)
rownames(plot.data)[1] <- other_name
plot.data <- plot.data[,labels(specimen.dend)]
```

Prepare specimen annotation in same order as columns of plot.data

```{r}
sexpartners <- with(sample_data(phy),
                    setNames(sexpartners, specimen_name))[colnames(plot.data)]
ngu_status <- with(sample_data(phy),
                   setNames(ngu_status, specimen_name))[colnames(plot.data)]
```

## heatmap

Finally, a plot. See http://stackoverflow.com/questions/6673162/reproducing-lattice-dendrogram-graph-with-ggplot2

```{r, fig.width = 12, fig.height = 10}
levelplot(
    t(plot.data),
    panel=function(...){
      panel.levelplot(..., colorkey=list(space='right'))
    },
    scales=list(x=list(rot=90, cex=0.5, alternating=3)),
    aspect="fill",
    legend=list(
        top=list(
            fun=latticeExtra::dendrogramGrob,
            args=list(
                x=specimen.dend,
                add=list(
                    rect=list(
                        fill=ifelse(sexpartners == 'MSM', 'black', 'white')),
                    rect=list(
                        fill=ifelse(ngu_status== 'Positive', 'red', 'white'))
                ),
                side='top',
                size=5))
    ),
    xlab=NULL,
    ylab=NULL
)
```

# version info

```{r}
packageVersion("phyloseq")
```

```{r}
getwd()
```

```{sh}
git --no-pager log -n1
```

```{sh}
git status
```
